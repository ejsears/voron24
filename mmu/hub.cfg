[gcode_macro _HubClear]
gcode:
  {% set Tool = params.TOOL %}
  {% if printer['filament_switch_sensor hub'].filament_detected is sameas true %}
    MANUAL_STEPPER STEPPER={Tool} MOVE=-120 SPEED=25 SET_POSITION=0
    MANUAL_STEPPER STEPPER={Tool} ENABLE=0
  {% endif %} 
  
[gcode_macro _Hub_Load]
gcode:
  {% set choiceS = params.CAS|default(cas1) %}
  {% set loaded = 'true' %}
   {% if params.CAS == "cas1" %}
    {% if printer.save_variables.variables.cas1 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CAS == "cas2" %}
    {% if printer.save_variables.variables.cas2 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CAS == "cas3" %}
    {% if printer.save_variables.variables.cas3 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CAS == 'cas4' %}
    {% if printer.save_variables.variables.cas4 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% endif %}
  m118 loaded= { params.CAS } { loaded } { printer.save_variables.variables.cas4 }
  {% if loaded == 'false' %}
    SET_SERVO SERVO={choiceS} ANGLE={printer["gcode_macro _MMU_VAR"].servo_down_angle}
    MANUAL_STEPPER STEPPER={choiceS} MOVE={printer["gcode_macro _MMU_VAR"].min_hub_length} SPEED=75 ACCEL=50 SET_POSITION=0
    {% set step = 0 %}
    {% for step in range(printer["gcode_macro _MMU_VAR"].loop_count) %}
      _Track_Check_Hub_Load CASEX={choiceS}
    {% endfor %}
    MANUAL_STEPPER STEPPER={choiceS} ENABLE=0
    SET_SERVO SERVO={choiceS} ANGLE={printer["gcode_macro _MMU_VAR"].servo_up_angle}
  {% endif %}

[gcode_macro _Track_Check_Hub_Load]
gcode:
  {% set loaded = 'true' %}2
  {% if params.CASEX == "cas1" %}
    {% if printer.save_variables.variables.cas1 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CASEX == "cas2" %}
    {% if printer.save_variables.variables.cas2 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CASEX == "cas3" %}
    {% if printer.save_variables.variables.cas3 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% elif params.CASEX == "cas4" %}
    {% if printer.save_variables.variables.cas4 == 0 %}
      {% set loaded = 'false' %}
    {% endif %}
  {% endif %}
  {% if loaded == 'false' %}
    {% if printer['filament_switch_sensor hub'].filament_detected is sameas true %}
      MANUAL_STEPPER STEPPER={params.CASEX} MOVE=-80 SPEED=5 SET_POSITION=0
      {% if params.CASEX == "cas1" %}
        SAVE_VARIABLE VARIABLE=cas1 VALUE="1"
      {% elif params.CASEX == "cas2" %}
        SAVE_VARIABLE VARIABLE=cas2 VALUE="1"
      {% elif params.CASEX == "cas3" %}
        SAVE_VARIABLE VARIABLE=cas3 VALUE="1"
      {% elif params.CASEX == "cas4" %}
        SAVE_VARIABLE VARIABLE=cas4 VALUE="1"
      {% endif %}
    {% else %}
      MANUAL_STEPPER STEPPER={params.CASEX} MOVE=15 SPEED=5 SET_POSITION=0 #SYNC=0
    {% endif %}
  {% endif %}

[gcode_macro _HUB_CUTING]
gcode:
  {% set Tool = params.TOOL %}
  {% for cut in range(25) %}
    _HubClear TOOL={ params.TOOL }
  {% endfor %}
  SET_SERVO SERVO=cut ANGLE={printer["gcode_macro _MMU_VAR"].servo_cut_prep}
  SET_SERVO SERVO={Tool} ANGLE={printer["gcode_macro _MMU_VAR"].servo_down_angle}
  MANUAL_STEPPER STEPPER={Tool} MOVE=200 SPEED=75 ACCEL=50 SET_POSITION=0
  SET_SERVO SERVO=cut ANGLE={printer["gcode_macro _MMU_VAR"].servo_cut_clip}
  G4 P1000
  SET_SERVO SERVO=cut ANGLE={printer["gcode_macro _MMU_VAR"].servo_cut_pass}

  